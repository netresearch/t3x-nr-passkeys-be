name: TER Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 0.1.0)'
        required: true
        type: string

permissions: {}

jobs:
  publish:
    name: Publish to TER
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      TYPO3_EXTENSION_KEY: nr_passkeys_be
      TYPO3_API_TOKEN: ${{ secrets.TYPO3_TER_ACCESS_TOKEN }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Determine version
        id: get-version
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [[ -n "${INPUT_VERSION}" ]]; then
            if ! [[ "${INPUT_VERSION}" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
              echo "Invalid version format: ${INPUT_VERSION}"
              echo "Expected format: 0.1.0"
              exit 1
            fi
            echo "version=${INPUT_VERSION}" >> "$GITHUB_ENV"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            echo "version=${TAG}" >> "$GITHUB_ENV"
          fi

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ env.version }}

      - name: Prepare release comment
        env:
          TAG_VERSION: ${{ env.version }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          if [[ -n "${RELEASE_BODY}" ]]; then
            COMMENT=$(echo "${RELEASE_BODY}" | sed 's/[#*+=~^|\\<>]//g' | head -c 1000)
          elif [[ -n "${RELEASE_NAME}" ]]; then
            COMMENT="${RELEASE_NAME}"
          else
            COMMENT="Released version ${TAG_VERSION} of nr_passkeys_be"
          fi

          if [[ -z "${COMMENT// }" ]]; then
            COMMENT="Released version ${TAG_VERSION} of nr_passkeys_be"
          fi

          if [[ -n "${RELEASE_URL}" ]]; then
            COMMENT=$(printf '%s\n\nDetails: %s' "${COMMENT}" "${RELEASE_URL}")
          fi

          {
            echo "comment<<EOF"
            echo "${COMMENT}"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: '8.3'
          extensions: intl, mbstring, json, zip, curl
          tools: composer:v2

      - name: Install tailor
        run: composer global require typo3/tailor --prefer-dist --no-progress

      - name: Upload to TER
        env:
          RELEASE_COMMENT: ${{ env.comment }}
          RELEASE_VERSION: ${{ env.version }}
        run: |
          php ~/.composer/vendor/bin/tailor ter:publish --comment "${RELEASE_COMMENT}" "${RELEASE_VERSION}"
