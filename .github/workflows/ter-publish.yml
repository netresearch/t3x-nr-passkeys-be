name: TER Publish

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag to publish (e.g. 0.1.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    name: Publish to TER
    runs-on: ubuntu-latest
    environment: typo3-ter

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ steps.version.outputs.tag }}

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: '8.2'
          coverage: none

      - name: Install tailor
        run: composer global require typo3/tailor --no-progress

      - name: Upload to TER
        env:
          TYPO3_API_TOKEN: ${{ secrets.TYPO3_API_TOKEN }}
        run: |
          php ~/.composer/vendor/bin/tailor ter:publish "${{ steps.version.outputs.tag }}" --extension-key nr_passkeys_be
