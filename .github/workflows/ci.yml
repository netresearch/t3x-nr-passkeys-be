name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions: read-all

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: '8.4'
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Composer audit
        run: composer audit --format=plain

  lint:
    name: Lint (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.2', '8.3', '8.4', '8.5']
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: ${{ matrix.php }}
          tools: php-cs-fixer
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run php-cs-fixer
        run: composer ci:lint:php

  stan:
    name: PHPStan (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: '8.2'
            typo3: '^13.4'
          - php: '8.3'
            typo3: '^13.4'
          - php: '8.4'
            typo3: '^13.4'
          - php: '8.2'
            typo3: '^14.1'
          - php: '8.3'
            typo3: '^14.1'
          - php: '8.4'
            typo3: '^14.1'
          - php: '8.5'
            typo3: '^14.1'
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: ${{ matrix.php }}
          coverage: none

      - name: Remove incompatible dev deps for TYPO3 v14
        if: startsWith(matrix.typo3, '^14')
        run: composer remove --dev --no-update saschaegerer/phpstan-typo3

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          composer require --no-update \
            "typo3/cms-core:${TYPO3_VERSION}" \
            "typo3/cms-backend:${TYPO3_VERSION}" \
            "typo3/cms-setup:${TYPO3_VERSION}"
          composer install --prefer-dist --no-progress

      - name: Run PHPStan
        run: composer ci:stan

  unit:
    name: Unit Tests (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: '8.2'
            typo3: '^13.4'
          - php: '8.3'
            typo3: '^13.4'
          - php: '8.4'
            typo3: '^13.4'
          - php: '8.5'
            typo3: '^13.4'
          - php: '8.2'
            typo3: '^14.1'
          - php: '8.3'
            typo3: '^14.1'
          - php: '8.4'
            typo3: '^14.1'
          - php: '8.5'
            typo3: '^14.1'
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, json, openssl
          coverage: pcov

      - name: Remove incompatible dev deps for TYPO3 v14
        if: startsWith(matrix.typo3, '^14')
        run: composer remove --dev --no-update saschaegerer/phpstan-typo3

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          composer require --no-update \
            "typo3/cms-core:${TYPO3_VERSION}" \
            "typo3/cms-backend:${TYPO3_VERSION}" \
            "typo3/cms-setup:${TYPO3_VERSION}"
          composer install --prefer-dist --no-progress

      - name: Run unit tests
        run: composer ci:test:php:unit -- --coverage-clover=coverage-unit.xml

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-unit.xml
          flags: unit
          fail_ci_if_error: false

  functional:
    name: Functional Tests (PHP ${{ matrix.php }}, TYPO3 ${{ matrix.typo3 }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: '8.2'
            typo3: '^13.4'
          - php: '8.3'
            typo3: '^13.4'
          - php: '8.4'
            typo3: '^13.4'
          - php: '8.5'
            typo3: '^13.4'
          - php: '8.2'
            typo3: '^14.1'
          - php: '8.3'
            typo3: '^14.1'
          - php: '8.4'
            typo3: '^14.1'
          - php: '8.5'
            typo3: '^14.1'
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: typo3_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, json, openssl, pdo_mysql
          coverage: pcov

      - name: Remove incompatible dev deps for TYPO3 v14
        if: startsWith(matrix.typo3, '^14')
        run: composer remove --dev --no-update saschaegerer/phpstan-typo3

      - name: Install TYPO3
        env:
          TYPO3_VERSION: ${{ matrix.typo3 }}
        run: |
          composer require --no-update \
            "typo3/cms-core:${TYPO3_VERSION}" \
            "typo3/cms-backend:${TYPO3_VERSION}" \
            "typo3/cms-setup:${TYPO3_VERSION}"
          composer install --prefer-dist --no-progress

      - name: Run functional tests
        env:
          typo3DatabaseDriver: mysqli
          typo3DatabaseHost: 127.0.0.1
          typo3DatabasePort: 3306
          typo3DatabaseName: typo3_test
          typo3DatabaseUsername: root
          typo3DatabasePassword: root
        run: composer ci:test:php:functional -- --coverage-clover=coverage-functional.xml

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage-functional.xml
          flags: functional
          fail_ci_if_error: false

  fuzz:
    name: Fuzz Tests
    runs-on: ubuntu-latest
    needs: [unit]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: '8.4'
          extensions: mbstring, json, openssl
          coverage: none

      - name: Remove incompatible dev deps for TYPO3 v14
        run: composer remove --dev --no-update saschaegerer/phpstan-typo3

      - name: Install TYPO3
        run: |
          composer require --no-update \
            "typo3/cms-core:^14.1" \
            "typo3/cms-backend:^14.1" \
            "typo3/cms-setup:^14.1"
          composer install --prefer-dist --no-progress

      - name: Run fuzz tests
        run: .Build/bin/phpunit -c phpunit.xml --testsuite fuzz --no-coverage

  mutation:
    name: Mutation Tests
    runs-on: ubuntu-latest
    needs: [unit]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # 2.36.0
        with:
          php-version: '8.4'
          extensions: mbstring, json, openssl
          coverage: pcov

      - name: Remove incompatible dev deps for TYPO3 v14
        run: composer remove --dev --no-update saschaegerer/phpstan-typo3

      - name: Install TYPO3
        run: |
          composer require --no-update \
            "typo3/cms-core:^14.1" \
            "typo3/cms-backend:^14.1" \
            "typo3/cms-setup:^14.1"
          composer install --prefer-dist --no-progress

      - name: Run mutation tests
        run: composer ci:mutation
