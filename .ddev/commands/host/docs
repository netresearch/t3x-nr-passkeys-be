#!/bin/bash

## Description: Render TYPO3 extension documentation to HTML
## Usage: docs
## Example: "ddev docs"

PROJECT_DIR="$(pwd)"
DOC_SOURCE="${PROJECT_DIR}/Documentation"
DOC_OUTPUT="${PROJECT_DIR}/Documentation-GENERATED-temp"

echo "Rendering TYPO3 Extension Documentation"
echo "========================================="

# Check if Documentation directory exists
if [ ! -d "$DOC_SOURCE" ]; then
    echo "Error: Documentation directory not found"
    echo "Tip: Create a Documentation/ directory with Index.rst to get started"
    exit 1
fi

# Check if guides.xml exists
if [ ! -f "$DOC_SOURCE/guides.xml" ]; then
    echo "Error: guides.xml not found in Documentation/"
    echo "Tip: Create Documentation/guides.xml as the build configuration"
    exit 1
fi

echo "Source:  Documentation/"
echo "Output:  Documentation-GENERATED-temp/"
echo ""

# Clean previous output
if [ -d "$DOC_OUTPUT" ]; then
    echo "Cleaning previous documentation build..."
    rm -rf "$DOC_OUTPUT"
fi

# Render documentation using TYPO3's official docker image
echo "Rendering documentation with TYPO3 render-guides..."
echo ""

docker run --rm --pull always \
    -v "${PROJECT_DIR}:/project" \
    ghcr.io/typo3-documentation/render-guides:latest \
    --config=Documentation 2>&1

RENDER_EXIT=$?

if [ $RENDER_EXIT -eq 0 ] && [ -d "$DOC_OUTPUT" ]; then
    echo ""
    echo "========================================="
    echo "Documentation rendered successfully!"
    echo ""
    echo "View at: https://docs.$(ddev describe -j | jq -r .raw.name).ddev.site/"
    echo "Output:  Documentation-GENERATED-temp/"
    echo ""
else
    echo ""
    echo "Documentation rendering failed (exit code: $RENDER_EXIT)"
    echo "Check your .rst files for syntax errors"
    exit 1
fi
