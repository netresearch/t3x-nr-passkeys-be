#!/bin/bash

## Description: Install TYPO3 14.x with your extension
## Usage: install-v14
## Example: ddev install-v14

VERSION=v14

rm -rf /var/www/html/$VERSION/*
mkdir -p /var/www/html/$VERSION/
echo "{}" > /var/www/html/$VERSION/composer.json
composer config extra.typo3/cms.web-dir public -d /var/www/html/$VERSION
composer config repositories.$EXTENSION_KEY path ../../$EXTENSION_KEY -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/cms-composer-installers true -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/class-alias-loader true -d /var/www/html/$VERSION
# t3/cms has no v14 release - use typo3/minimal + additional packages
# typo3/minimal provides: cms-core, cms-backend, cms-extbase, cms-filelist, cms-fluid, cms-frontend
# typo3/cms-install provides: setup command, configuration:set
composer req typo3/minimal:'^14' typo3/cms-install:'^14' typo3/cms-fluid-styled-content:'^14' typo3/cms-rte-ckeditor:'^14' $PACKAGE_NAME:'*@dev' --no-progress -n -d /var/www/html/$VERSION
composer req typo3/cms-extensionmanager --no-progress -n -d /var/www/html/$VERSION
composer req --dev typo3/cms-styleguide --no-progress -n -d /var/www/html/$VERSION

# Introduction Package may not support latest TYPO3 v14 - install if available
if composer req typo3/cms-introduction --no-progress -n -d /var/www/html/$VERSION 2>/dev/null; then
    INTRO_INSTALLED=true
else
    echo "Note: typo3/cms-introduction not available for TYPO3 v14 - skipping demo content"
    INTRO_INSTALLED=false
fi

cd /var/www/html/$VERSION

mysql -h db -u root -p"root" -e "DROP DATABASE IF EXISTS ${VERSION};"
mysql -h db -u root -p"root" -e "CREATE DATABASE ${VERSION};"

vendor/bin/typo3 setup -n --dbname=$VERSION --password=$TYPO3_DB_PASSWORD --create-site="https://${VERSION}.nr-passkeys-be.ddev.site" --admin-user-password=$TYPO3_SETUP_ADMIN_PASSWORD

# Write all configuration directly to additional.php (configuration:set may not exist in v14)
mkdir -p /var/www/html/$VERSION/config/system
cat > /var/www/html/$VERSION/config/system/additional.php << 'ADDITIONALPHP'
<?php
$GLOBALS['TYPO3_CONF_VARS']['BE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['FE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['devIPmask'] = '*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['displayErrors'] = 1;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['trustedHostsPattern'] = '.*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['features']['security.backend.enforceReferrer'] = false;
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['transport'] = 'smtp';
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['transport_smtp_server'] = 'localhost:1025';
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['defaultMailFromAddress'] = 'admin@example.com';
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor'] = 'ImageMagick';
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor_path'] = '/usr/bin/';
ADDITIONALPHP

# Enable deprecation log if settings.php exists
if [ -f /var/www/html/$VERSION/config/system/settings.php ]; then
    sed -i "/'deprecations'/,/^[[:space:]]*'disabled' => true,/s/'disabled' => true,/'disabled' => false,/" /var/www/html/$VERSION/config/system/settings.php
fi

vendor/bin/typo3 extension:setup

# Configure site sets for v14 (only if Bootstrap Package is available via introduction)
if [ "$INTRO_INSTALLED" = "true" ] && [ -f config/sites/main/config.yaml ]; then
    if ! grep -q "^dependencies:" config/sites/main/config.yaml; then
        echo "" >> config/sites/main/config.yaml
        echo "dependencies:" >> config/sites/main/config.yaml
        echo "  - bootstrap-package/full" >> config/sites/main/config.yaml
        echo "Site sets configured with Bootstrap Package"
    fi
fi

# Generate styleguide demo content for UI pattern reference
vendor/bin/typo3 styleguide:generate
echo "Styleguide demo content generated"

vendor/bin/typo3 cache:flush

echo ""
echo "TYPO3 $VERSION installation complete!"
echo "Your extension is activated and ready to use"
echo "TYPO3 Styleguide is available for UI pattern reference"
if [ "$INTRO_INSTALLED" = "true" ]; then
    echo "Introduction Package installed with demo content"
else
    echo "Introduction Package skipped (not yet available for TYPO3 v14)"
fi

# Auto-configure extension if configure script exists
if [ -f "/mnt/ddev_config/commands/web/configure-nr_passkeys_be" ]; then
    echo ""
    echo "Auto-configuring nr_passkeys_be extension..."
    /mnt/ddev_config/commands/web/configure-nr_passkeys_be $VERSION
fi
